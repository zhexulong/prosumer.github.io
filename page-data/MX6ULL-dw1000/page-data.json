{"componentChunkName":"component---src-templates-blog-post-js","path":"/MX6ULL-dw1000/","result":{"data":{"site":{"siteMetadata":{"title":"且听龙吟"}},"markdownRemark":{"id":"5250e9d9-0d80-59f0-b1f3-c7b3f03cd601","excerpt":"相较于网上的其他驱动而言,这个驱动结构较为简单,并且需要的内核版本也较低,可以在略微修改之后兼容linux4.1版本,因而选择该驱动 首先,为这个驱动配套一版设备树 我们需要根据 编写一版驱动\r\n根据教程\r\n\r\n\r\n我们可以对应修改即可 解决缺少IEEE80215…","html":"<p>相较于网上的其他驱动而言,这个驱动结构较为简单,并且需要的内核版本也较低,可以在略微修改之后兼容linux4.1版本,因而选择该驱动</p>\n<h2>首先,为这个驱动配套一版设备树</h2>\n<p>我们需要根据</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">\trstn = devm_gpiod_get(&amp;spi->dev, \"rstn\", GPIOD_OUT_LOW);</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">static const struct of_device_id dw1000_of_match[] = {\r\n\t{ .compatible = \"decaWave,dw1000\", },\r\n\t{ },\r\n};\r\nMODULE_DEVICE_TABLE(of, dw1000_of_match);\r\n\r\nstatic const struct spi_device_id dw1000_device_id[] = {\r\n\t{ .name = \"dw1000\", },\r\n\t{ },\r\n};\r\nMODULE_DEVICE_TABLE(spi, dw1000_device_id);\r\n\r\nstatic struct spi_driver dw1000_driver = {\r\n\t.id_table = dw1000_device_id,\r\n\t.driver = {\r\n\t\t.of_match_table = dw1000_of_match,\r\n\t\t.name\t= \"dw1000\",\r\n\t},\r\n\t.probe      = dw1000_probe,\r\n\t.remove     = dw1000_remove,\r\n};\r\n</code></pre></div>\n<p>编写一版驱动\r\n根据教程\r\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c7341dc9ce2d169c7552171d815fe934/00172/img.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.56962025316456%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAABQ0lEQVR42l1R2ZKDIBDM/3/eitSqUe5DSYwcUfOiO0qlsrsNTDVKF9P0Zd/3eZ6du2mtldbihD42sNOZW9sbrfu+d84ZY6dp2rYNhBdY4zgqrZwbUkrruoTkxzD66GFOcfLJxzku8/x8phBCTGlZlv3EIXZ9X9d10zRQSUfRN0INJoK0vL2ya65KnZ2cHRljPjff3SC4YIyVZYnxd1U1pCMwKaGUMEao4FJLplhLBaOc/hGPNwfejNFVXWGMyxKVGQc/0BJiWKs7fGVtRWrw+EvseimFlBKOowJ9FQVCKOuKkzMuDWtMh2va4BZDG/v29vy4O2ibUv62lR/+P8C1hKGUtfZz8+v1gsPDMOR/YIlzTikFLqQw2hzpQW9HkZwL+P55bYiKEGIhQWtjjCnGEMNjmiC5GIL3PhwRAQ3rup40ZvEPLnrrIHytYbsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img.png\"\n        title=\"\"\n        src=\"/static/c7341dc9ce2d169c7552171d815fe934/f058b/img.png\"\n        srcset=\"/static/c7341dc9ce2d169c7552171d815fe934/c26ae/img.png 158w,\n/static/c7341dc9ce2d169c7552171d815fe934/6bdcf/img.png 315w,\n/static/c7341dc9ce2d169c7552171d815fe934/f058b/img.png 630w,\n/static/c7341dc9ce2d169c7552171d815fe934/40601/img.png 945w,\n/static/c7341dc9ce2d169c7552171d815fe934/00172/img.png 1044w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\r\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6eed9598806b2dc467a187bf19fc0ede/0a867/img_1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 59.49367088607595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABe0lEQVR42oWS2Y7jIBBF+/9/rh/SCftmNi8Zt4M9UmyIPIWllnqfo1JhGS63gHra972UEmN0zhljKCGQueCQ53nOpWxA3g7WFT5LWdf18XiA8AmG6/XqvVdKNU0TQujabugH7zxs18YIf5zzMKW1htx1nZRymm5VnHOOse37PgQ/juO8pDGNU5ogbvNtmqe0pCm9jjeYmv8eLMtyv9+ruJSslcYYS6msdUwxxBGVlCtBJRONgGCaUUWMNf4AKoJiD3HevLWCC4wwYwIhyihVgjMqIJTSSpngofoYfPgsztvaess4P51O6IKfn88YE8nh4ggXcDophIIzv+ed87ZGbznnGCMpJEjAXyoJtVTPA+9/EOe8BWe1MWBiGqu1MqaBFSHEr7JvnINrQEwq+Hy+EMLgVUxFG63hFn8VWx3bllL28nJBiHDOBBTOuVf1CZz7zfnujQADENTgtVUs2B28jR+ABcMwHB1WytB1fX+FDhlfa/rzP8A2pbTv+z/BU4rr+oajxgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img_1.png\"\n        title=\"\"\n        src=\"/static/6eed9598806b2dc467a187bf19fc0ede/f058b/img_1.png\"\n        srcset=\"/static/6eed9598806b2dc467a187bf19fc0ede/c26ae/img_1.png 158w,\n/static/6eed9598806b2dc467a187bf19fc0ede/6bdcf/img_1.png 315w,\n/static/6eed9598806b2dc467a187bf19fc0ede/f058b/img_1.png 630w,\n/static/6eed9598806b2dc467a187bf19fc0ede/40601/img_1.png 945w,\n/static/6eed9598806b2dc467a187bf19fc0ede/0a867/img_1.png 986w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\r\n我们可以对应修改即可</p>\n<h2>解决缺少IEEE802154模块问题</h2>\n<p>移植完设备树,并将驱动编译成功发到开发板上,调试时发现报错</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">dw1000: Unknown symbol ieee802154_alloc_hw (err 0)\r\ndw1000: Unknown symbol ieee802154_xmit_complete (err 0)\r\ndw1000: Unknown symbol ieee802154_rx_irqsafe (err 0)\r\ndw1000: Unknown symbol ieee802154_unregister_hw (err 0)\r\ndw1000: Unknown symbol ieee802154_free_hw (err 0)\r\ndw1000: Unknown symbol ieee802154_register_hw (err 0)\r\ndw1000: Unknown symbol ieee802154_alloc_hw (err 0)\r\ndw1000: Unknown symbol ieee802154_xmit_complete (err 0)\r\ndw1000: Unknown symbol ieee802154_rx_irqsafe (err 0)\r\ndw1000: Unknown symbol ieee802154_unregister_hw (err 0)</code></pre></div>\n<p>为了加载该模块,需要在相应的defconfig(正点原子为imx_alientek_emmc_defconfig)中加入</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">CONFIG_IEEE802154=y\r\nCONFIG_MAC802154=y</code></pre></div>\n<p>然后重新</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">make imx_alientek_emmc_defconfig\r\nmake all -j12</code></pre></div>\n<p>然后发现报错变为了</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">dw1000: no symbol version for ieee802154_free_hw\r\ndw1000: Unknown symbol ieee802154_free_hw (err -22)\r\ndw1000: no symbol version for ieee802154_register_hw\r\ndw1000: Unknown symbol ieee802154_register_hw (err -22)\r\ndw1000: no symbol version for ieee802154_alloc_hw\r\ndw1000: Unknown symbol ieee802154_alloc_hw (err -22)\r\ndw1000: no symbol version for ieee802154_xmit_complete\r\ndw1000: Unknown symbol ieee802154_xmit_complete (err -22)\r\ndw1000: no symbol version for ieee802154_rx_irqsafe\r\ndw1000: Unknown symbol ieee802154_rx_irqsafe (err -22)\r\ndw1000: no symbol version for ieee802154_unregister_hw\r\ndw1000: Unknown symbol ieee802154_unregister_hw (err -22)\r\ndw1000: no symbol version for ieee802154_free_hw\r\ndw1000: Unknown symbol ieee802154_free_hw (err -22)\r\ndw1000: no symbol version for ieee802154_register_hw\r\ndw1000: Unknown symbol ieee802154_register_hw (err -22)\r\ndw1000: no symbol version for ieee802154_alloc_hw\r\ndw1000: Unknown symbol ieee802154_alloc_hw (err -22)\r\ndw1000: no symbol version for ieee802154_xmit_complete\r\ndw1000: Unknown symbol ieee802154_xmit_complete (err -22)\r\ndw1000: no symbol version for ieee802154_rx_irqsafe\r\ndw1000: Unknown symbol ieee802154_rx_irqsafe (err -22)\r\ndw1000: no symbol version for ieee802154_unregister_hw\r\ndw1000: Unknown symbol ieee802154_unregister_hw (err -22)\r\nmodprobe: can't load module dw1000.ko (dw1000.ko): Invalid argument</code></pre></div>\n<p>这就是因为虽然我们的内核更新了,但是驱动没能成功重新链接相应符号\r\n所以我们要重新编译驱动\r\n这是相应的Makefile</p>\n<div class=\"gatsby-highlight\" data-language=\"makefile\"><pre class=\"language-makefile\"><code class=\"language-makefile\">obj-m <span class=\"token operator\">+=</span> dw1000.o\r\nKERNELDIR <span class=\"token operator\">:=</span> /home/alientek/linux/IMX6ULL/linux/linux-imx-rel_imx_4.1.15_2.1.0_ga\r\nENV<span class=\"token operator\">:=</span>ARCH<span class=\"token operator\">=</span>arm CROSS_COMPILE<span class=\"token operator\">=</span>arm-linux-gnueabihf-\r\nCURRENT_PATH <span class=\"token operator\">:=</span> <span class=\"token variable\">$</span><span class=\"token punctuation\">(</span><span class=\"token function\">shell</span> pwd<span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token target symbol\">build</span><span class=\"token punctuation\">:</span> kernel_modules\r\n\r\n<span class=\"token target symbol\">kernel_modules</span><span class=\"token punctuation\">:</span>\r\n\t<span class=\"token variable\">$</span><span class=\"token punctuation\">(</span>MAKE<span class=\"token punctuation\">)</span> <span class=\"token variable\">$</span><span class=\"token punctuation\">(</span>ENV<span class=\"token punctuation\">)</span> -C <span class=\"token variable\">$</span><span class=\"token punctuation\">(</span>KERNELDIR<span class=\"token punctuation\">)</span> M<span class=\"token operator\">=</span><span class=\"token variable\">$</span><span class=\"token punctuation\">(</span>CURRENT_PATH<span class=\"token punctuation\">)</span> modules\r\n\r\n<span class=\"token target symbol\">clean</span><span class=\"token punctuation\">:</span>\r\n\t<span class=\"token variable\">$</span><span class=\"token punctuation\">(</span>MAKE<span class=\"token punctuation\">)</span> <span class=\"token variable\">$</span><span class=\"token punctuation\">(</span>ENV<span class=\"token punctuation\">)</span> -C <span class=\"token variable\">$</span><span class=\"token punctuation\">(</span>KERNELDIR<span class=\"token punctuation\">)</span> M<span class=\"token operator\">=</span><span class=\"token variable\">$</span><span class=\"token punctuation\">(</span>CURRENT_PATH<span class=\"token punctuation\">)</span> clean\r\n</code></pre></div>\n<p>make之后传到板子的根文件系统中</p>\n<h2>发现并解决设备树冲突/问题</h2>\n<p>驱动能够运行了,但是发现读不到东西</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">dw1000 spi2.0: Detected DW1000 chip id: 0x00000000</code></pre></div>\n<p>这是因为当前的设备树有冲突,可以运行命令</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">dmesg | grep spi</code></pre></div>\n<p>发现报错</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">imx6ul-pinctrl 20e0000.iomuxc: pin MX6UL_PAD_UART2_TX_DATA already requested by 21e8000.serial; cannot claim for 2010000.ecspi\r\nimx6ul-pinctrl 20e0000.iomuxc: pin-37 (2010000.ecspi) status -22</code></pre></div>\n<p>查看设备树可以发现,是因为uart2和我们使用了相同的引脚,将uart2设置为disable即可\r\n结果发现,还是没成功,chip id应该是0xDECA0130,结果是</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">dw1000 spi2.0: Detected DW1000 chip id: 0x80808000</code></pre></div>\n<p>为了能够及时发现自己的设备树编写和驱动probe的过程中是否有问题,我们可以加上下面两句:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">\t<span class=\"token function\">printk</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dw1000: rstn gpio is %d\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">gpiod_to_irq</span><span class=\"token punctuation\">(</span>rstn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\t<span class=\"token function\">printk</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dw1000: spi pins are %d\\n\"</span><span class=\"token punctuation\">,</span> spi<span class=\"token operator\">-></span>cs_gpio<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>同时,可以把dev_dbg重新定义为</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">dev_dbg</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>dev<span class=\"token punctuation\">,</span> fmt<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span> </span><span class=\"token punctuation\">\\</span>\r\n\t<span class=\"token expression\"><span class=\"token function\">printk</span><span class=\"token punctuation\">(</span>KERN_DEBUG </span><span class=\"token string\">\"%s: \"</span> <span class=\"token expression\">fmt<span class=\"token punctuation\">,</span> <span class=\"token function\">dev_name</span><span class=\"token punctuation\">(</span>dev<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> </span><span class=\"token punctuation\">##</span><span class=\"token expression\">args<span class=\"token punctuation\">)</span></span></span></code></pre></div>\n<p>然后发现</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">dw1000: rstn gpio is 36\r\ndw1000: spi pins are -2</code></pre></div>\n<p>这就说明我们spi的cs_gpio有问题,回看设备树\r\n发现</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">\tcs-gpio = &lt;&amp;gpio1 20 GPIO_ACTIVE_LOW>;</code></pre></div>\n<p>改为</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">\tcs-gpios = &lt;&amp;gpio1 20 GPIO_ACTIVE_LOW>;</code></pre></div>\n<p>终于,发现能够成功打印出</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">dw1000 spi2.0: Detected DW1000 chip id: 0xdeca0130\r\ndw1000 spi2.0: OTP Rev: 0x60\r\ndw1000 spi2.0: OTP LDO Turn: 0xfe\r\ndw1000 spi2.0: OTP XTAL Trim: 0xfe\r\ndw1000 spi2.0: Microcode is loaded</code></pre></div>\n<p>但是由于当前版本的linux中没有ieee802154_is_valid_extended_unicast_addr函数,所以暂时</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">OTP EUI not found</code></pre></div>\n<p>参考:\r\n<a href=\"https://github.com/xueliu/dw1000-linux.git\">xueliu/dw1000-linux驱动源码</a>\r\n<a href=\"https://blog.csdn.net/hshl1214/article/details/8769112\">关于内核模块挂载出现“no symbol version for”问题的研究</a></p>","frontmatter":{"title":"正点原子I.MX6ULL mini适配xueliu dw1000驱动","date":"May 11, 2024","description":"linux设备树驱动适配"}},"previous":{"fields":{"slug":"/rk3588/"},"frontmatter":{"title":"从医学图像分割pipeline搭建到rk3588板端推理部署"}},"next":{"fields":{"slug":"/rk3588-prone/"},"frontmatter":{"title":"从UNet模型剪枝到rk3588板端推理部署"}}},"pageContext":{"id":"5250e9d9-0d80-59f0-b1f3-c7b3f03cd601","previousPostId":"63eb493f-0667-502f-8e25-005235b8d964","nextPostId":"fe0076cb-deec-5f0b-9a21-f39854f27ff4"}},"staticQueryHashes":["230163734","2841359383"],"slicesMap":{}}